<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.12.3","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="​		本文记录了对标准L2switch和私有L2switch的阅读和解析.">
<meta property="og:type" content="article">
<meta property="og:title" content="L2switch">
<meta property="og:url" content="http://example.com/2022/09/01/L2switch/index.html">
<meta property="og:site_name" content="SDN BOLG">
<meta property="og:description" content="​		本文记录了对标准L2switch和私有L2switch的阅读和解析.">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-09-01T01:42:36.370Z">
<meta property="article:modified_time" content="2022-09-27T08:00:40.014Z">
<meta property="article:author" content="Simonck">
<meta property="article:tag" content="L2switch">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2022/09/01/L2switch/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2022/09/01/L2switch/","path":"2022/09/01/L2switch/","title":"L2switch"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>L2switch | SDN BOLG</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="SDN BOLG" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">SDN BOLG</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5"><span class="nav-number">1.</span> <span class="nav-text">基础概念</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Address-Tracker-%E6%9C%AA%E6%94%B9%E5%8A%A8"><span class="nav-number">2.</span> <span class="nav-text">Address Tracker(未改动)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#addressobserver"><span class="nav-number">2.1.</span> <span class="nav-text">addressobserver</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Arp-Handler-%E6%9C%AA%E6%94%B9%E5%8A%A8"><span class="nav-number">3.</span> <span class="nav-text">Arp Handler(未改动)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#core"><span class="nav-number">3.1.</span> <span class="nav-text">core:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flow"><span class="nav-number">3.2.</span> <span class="nav-text">flow:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inventory%EF%BC%9A"><span class="nav-number">3.3.</span> <span class="nav-text">inventory：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Host-Tracker-%E6%9C%89%E5%B0%8F%E6%94%B9%E5%8A%A8"><span class="nav-number">4.</span> <span class="nav-text">Host Tracker(有小改动)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#internal-%E5%B0%8F%E6%94%B9%E5%8A%A8"><span class="nav-number">4.1.</span> <span class="nav-text">internal(小改动)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inventory"><span class="nav-number">4.2.</span> <span class="nav-text">inventory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#util"><span class="nav-number">4.3.</span> <span class="nav-text">util</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Packet-Handler-%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="nav-number">5.</span> <span class="nav-text">Packet Handler(主要功能)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#decoder-%E6%9C%AA%E6%94%B9%E5%8A%A8"><span class="nav-number">5.1.</span> <span class="nav-text">decoder(未改动):</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PacketHandlerProvider%EF%BC%88%E6%9C%AA%E6%94%B9%E5%8A%A8%EF%BC%89%EF%BC%9A"><span class="nav-number">5.2.</span> <span class="nav-text">PacketHandlerProvider（未改动）：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blueprint-packet-handler-xml"><span class="nav-number">5.3.</span> <span class="nav-text">blueprint:packet-handler.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pom-xml-%E5%A2%9E%E5%8A%A0%E4%BA%86%E4%BE%9D%E8%B5%96%E9%A1%B9"><span class="nav-number">5.4.</span> <span class="nav-text">pom.xml:增加了依赖项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#control-%E5%A2%9E%E5%8A%A0"><span class="nav-number">5.5.</span> <span class="nav-text">control(增加):</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#icfp-%E5%A2%9E%E5%8A%A0"><span class="nav-number">5.6.</span> <span class="nav-text">icfp(增加):</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#loopremover-%E6%9A%82%E4%B8%8D%E4%BD%BF%E7%94%A8"><span class="nav-number">6.</span> <span class="nav-text">loopremover(暂不使用)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#loopremoverprovider"><span class="nav-number">6.1.</span> <span class="nav-text">loopremoverprovider</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flow-1"><span class="nav-number">6.2.</span> <span class="nav-text">flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#topology"><span class="nav-number">6.3.</span> <span class="nav-text">topology</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#util-1"><span class="nav-number">6.4.</span> <span class="nav-text">util</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#l2switch-main-%E4%B8%8D%E4%BD%BF%E7%94%A8"><span class="nav-number">7.</span> <span class="nav-text">l2switch-main(不使用)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#l2switch-impl-xml"><span class="nav-number">7.1.</span> <span class="nav-text">l2switch-impl.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#yang"><span class="nav-number">7.2.</span> <span class="nav-text">yang</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#L2SwitchMainProvider"><span class="nav-number">7.3.</span> <span class="nav-text">L2SwitchMainProvider</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flow-2"><span class="nav-number">7.4.</span> <span class="nav-text">flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#inventory-1"><span class="nav-number">7.5.</span> <span class="nav-text">inventory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#util-2"><span class="nav-number">7.6.</span> <span class="nav-text">util</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Simonck"
      src="https://fastly.jsdelivr.net/gh/Simonck33420/image/202208091628825.jpg">
  <p class="site-author-name" itemprop="name">Simonck</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/01/L2switch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://fastly.jsdelivr.net/gh/Simonck33420/image/202208091628825.jpg">
      <meta itemprop="name" content="Simonck">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SDN BOLG">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="L2switch | SDN BOLG">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          L2switch
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-01 09:42:36" itemprop="dateCreated datePublished" datetime="2022-09-01T09:42:36+08:00">2022-09-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-09-27 16:00:40" itemprop="dateModified" datetime="2022-09-27T16:00:40+08:00">2022-09-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SDN/" itemprop="url" rel="index"><span itemprop="name">SDN</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>​		本文记录了对标准L2switch和私有L2switch的阅读和解析.</p>
<span id="more"></span>

<h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><ul>
<li><p>项目目的：基于MD-SAL架构实现基本的2层交换功能,包括对早先版本的重构,适合学习MD-SAL架构</p>
</li>
<li><p>参考文献:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.sdnlab.com/18285.html">L2switch源码分析（上）</a></li>
<li><a target="_blank" rel="noopener" href="https://www.sdnlab.com/18293.html">L2switch源码分析（下）</a></li>
<li><a target="_blank" rel="noopener" href="https://heroacool.blog.csdn.net/article/details/51014824?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-51014824-blog-124864695.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~Rate-1-51014824-blog-124864695.pc_relevant_default&utm_relevant_index=2">Dijkstra算法</a></li>
</ul>
</li>
<li><p>项目模块：</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">模块名</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Packet Handler</td>
<td align="center">处理上送到控制器的报文,是项目的主要功能</td>
</tr>
<tr>
<td align="center">Loop Remover</td>
<td align="center">消除网络中的环路</td>
</tr>
<tr>
<td align="center">Arp Handler</td>
<td align="center">处理ARP报文</td>
</tr>
<tr>
<td align="center">Address Tracker</td>
<td align="center">学习网络中设备的IP地址和MAC地址,把地址存入datastore中inventory对应节点</td>
</tr>
<tr>
<td align="center">Host Tracker</td>
<td align="center">跟踪网络中的主机的拓扑位置</td>
</tr>
<tr>
<td align="center">L2Switch Main</td>
<td align="center">根据网络流量下发流表,依赖于上边模块的处理结果</td>
</tr>
</tbody></table>
<h2 id="Address-Tracker-未改动"><a href="#Address-Tracker-未改动" class="headerlink" title="Address Tracker(未改动)"></a>Address Tracker(未改动)</h2><h3 id="addressobserver"><a href="#addressobserver" class="headerlink" title="addressobserver"></a>addressobserver</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*AddressObservationWriter:添加mac地址和ip地址,以及节点的连接关系nodeConnectorRef*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addAddress</span><span class="token punctuation">(</span><span class="token class-name">MacAddress</span> macAddress<span class="token punctuation">,</span> <span class="token class-name">IpAddress</span> ipAddress<span class="token punctuation">,</span> <span class="token class-name">NodeConnectorRef</span> nodeConnectorRef<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*AddressObserverUsingArp:处理收到的ARP包notification,校验后调用
   addressObservationWriter.addAddress写入*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onArpPacketReceived</span><span class="token punctuation">(</span><span class="token class-name">ArpPacketReceived</span> packetReceived<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">RawPacketFields</span> rawPacket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">EthernetPacket</span> ethernetPacket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">ArpPacket</span> arpPacket <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
addressObservationWriter<span class="token punctuation">.</span><span class="token function">addAddress</span><span class="token punctuation">(</span>ethernetPacket<span class="token punctuation">.</span><span class="token function">getSourceMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">IpAddressBuilder</span><span class="token punctuation">.</span><span class="token function">getDefaultInstance</span><span class="token punctuation">(</span>arpPacket<span class="token punctuation">.</span><span class="token function">getSourceProtocolAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rawPacket<span class="token punctuation">.</span><span class="token function">getIngress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*AddressObserverUsingIpv4:处理IPv4包*/</span>

<span class="token comment">/*AddressObserverUsingIpv6:处理IPv6包*/</span>

<span class="token comment">/*AddressTrackerProvider:一般是AddressTracker模块的入口,初始化该模块的功能,初始化过程在Init()中,这个模块涉及notification的发布\侦听*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Arp-Handler-未改动"><a href="#Arp-Handler-未改动" class="headerlink" title="Arp Handler(未改动)"></a>Arp Handler(未改动)</h2><p>​		项目中由于系统的ip\mac相对变化不大,所以实际项目中不太需要处理ARP,使用的相关逻辑是私有的,不是标准的,保留这个模块是为以后做准备(删除或扩展).这里最重要的是<code>inventory.InventoryReader</code>方法,私有的处理datastore的方法就是根据它改的,加了功能和过滤.</p>
<table>
<thead>
<tr>
<th align="center">package</th>
<th align="center">内容</th>
</tr>
</thead>
<tbody><tr>
<td align="center">core</td>
<td align="center"><code>ArpHandlerProvider</code>\ <code>ArpPacketHandler</code>\ <code>PacketDispatcher</code>\ <code>ProactiveFloodFlowWriter</code></td>
</tr>
<tr>
<td align="center">flow</td>
<td align="center"><code>InitialFlowWriter</code></td>
</tr>
<tr>
<td align="center">inventory</td>
<td align="center"><code>InventoryReader</code></td>
</tr>
</tbody></table>
<h3 id="core"><a href="#core" class="headerlink" title="core:"></a>core:</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**ArpHandlerProvider:初始化ArpHandler模块(入口),关闭ArpHandler模块
主要关注Init(),这里判断了ARP是Proactive模式还是Reactive模式(主动与被动模式)
Proactive模式主动下发洪泛ARP的流表,Reactive模式下发把ARP报文上送至控制器的流表
前者调用 ProactiveFloodFlowWriter 后者调用InitialFlowWriter
再创建好读datastore、分发包、处理包、notification等对象*/</span>

<span class="token comment">/**ArpPacketHandler:处理送上来的ARP报文
类成员包括一个PacketDispatcher的对象,用来发包
主要成员方法是onArpPacketReceived,对notification进一步处理*/</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onArpPacketReceived</span><span class="token punctuation">(</span><span class="token class-name">ArpPacketReceived</span> packetReceived<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//收到的包经过校验计算、处理后,调用PacketDispatcher把包发出去</span>
  packetDispatcher<span class="token punctuation">.</span><span class="token function">dispatchPacket</span><span class="token punctuation">(</span>packetReceived<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rawPacket<span class="token punctuation">.</span><span class="token function">getIngress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                ethernetPacket<span class="token punctuation">.</span><span class="token function">getSourceMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ethernetPacket<span class="token punctuation">.</span><span class="token function">getDestinationMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**PacketDispatcher:把包发送出去,作为一个功能类定义了几个成员方法,典型的有*/</span>
    <span class="token comment">//把来自ingress节点的载荷payload发出去,按照源mac和目的mac的关系,调用洪泛或单播方法</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatchPacket</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> payload<span class="token punctuation">,</span> <span class="token class-name">NodeConnectorRef</span> ingress<span class="token punctuation">,</span> <span class="token class-name">MacAddress</span> srcMac<span class="token punctuation">,</span> <span class="token class-name">MacAddress</span> destMac<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**ProactiveFloodFlowWriter:用于L2Switch的proactive模式。在这种模式下，
造成洪泛的流表自动写入每个交换机，发送到控制器的(traffic)流量更少。*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="flow"><a href="#flow" class="headerlink" title="flow:"></a>flow:</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**InitialFlowWriter:给所有交换机下发将ARP数据包发送到控制器的流表,
与core.ProactiveFloodFlowWriter相对,有新交换机上线时会自动识别并下发*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="inventory："><a href="#inventory：" class="headerlink" title="inventory："></a>inventory：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**InventoryReader:用于读datastore数据
    详解见packethandler.xx.control.inventory.InventoryReader*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="Host-Tracker-有小改动"><a href="#Host-Tracker-有小改动" class="headerlink" title="Host Tracker(有小改动)"></a>Host Tracker(有小改动)</h2><p>主机上线,处理,完成之后把结果告诉私有模块.私有模块自己维护了一套相关的逻辑.</p>
<h3 id="internal-小改动"><a href="#internal-小改动" class="headerlink" title="internal(小改动)"></a>internal(小改动)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**internal:
----ConcurrentClusterAwareHostHashMap:并发集群感知主机host，使用ConcurrentHashMap集合来存放host的数据，提供增删改查之类的方法
----ConcurrentClusterAwareLinkHashMap:并发集群感知链接link，使用ConcurrentHashMap集合来存放link的数据，提供增删改查之类的方法
----HostTrackerImpl:是主机追踪模块的入口，包含init()等方法,监听data-tree增加、删除等变化，私有模块是在这里做了改动，
								发布了一个notification通知处理结果，是这个模块的主要功能类
----HostTrackerOperation:是接口，表示对事物的操作
----OperationProcessor:偏底层的实现,跟ODL的事务\事务链有关,在这个模块里向其它类提供服务
----SimpleAddressObserver:基于l2switch地址观测器的简单地址观测器，(具体作用?)
*/</span>
<span class="token comment">/**OperationProcessor: */</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OperationProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">AutoCloseable</span><span class="token punctuation">,</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> <span class="token class-name">TransactionChainListener</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**成员对象*/</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> NUM_RETRY_SUBMIT <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> OPS_PER_CHAIN <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> QUEUE_DEPTH <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOG <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">OperationProcessor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DataBroker</span> dataBroker<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HostTrackerOperation</span><span class="token punctuation">></span></span> queue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BindingTransactionChain</span><span class="token punctuation">></span></span> transactionChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/**构造器*/</span>
    <span class="token comment">/**成员方法*/</span>
    <span class="token function">onTransactionChainFailed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">onTransactionChainSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">chainFailure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">enqueueOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">submitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">clearQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>HostTrackerImpl会监听data tree的改变并根据不同的改变类型做出处理并修改数据树,私有模块在这里插入了AddHostBuilder和SayLinkBuilder,他们是由yang文件生成的,用来把ODL的处理结果发布成notification并被私有模块的listener订阅.这样就获取了主机上线、增加连接、删除连接等结果。定义的yang文件在hosttracker\model\src\main\yang\host-tracker-service.yang，添加内容如下：</p>
<pre class="line-numbers language-yang" data-language="yang"><code class="language-yang"><span class="token keyword">notification</span> say-link<span class="token punctuation">&#123;</span>
		<span class="token keyword">leaf</span> message<span class="token punctuation">&#123;</span>
	<span class="token keyword">type</span> string<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
		<span class="token keyword">leaf</span> linkType<span class="token punctuation">&#123;</span>
	<span class="token keyword">type</span> string<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
		<span class="token keyword">leaf</span> source<span class="token punctuation">&#123;</span>
	<span class="token keyword">type</span> string<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
		<span class="token keyword">leaf</span> destination<span class="token punctuation">&#123;</span>
	<span class="token keyword">type</span> string<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">notification</span> add-host<span class="token punctuation">&#123;</span>
		<span class="token keyword">leaf</span> ip<span class="token punctuation">&#123;</span>
	<span class="token keyword">type</span> string<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
		<span class="token keyword">leaf</span> mac<span class="token punctuation">&#123;</span>
	<span class="token keyword">type</span> string<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
		<span class="token keyword">leaf</span> ncID<span class="token punctuation">&#123;</span>
	<span class="token keyword">type</span> string<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**HostTrackerImpl:*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HostTrackerImpl</span> <span class="token keyword">implements</span> <span class="token class-name">DataTreeChangeListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataObject</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/**成员对象*/</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> CPUS <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> TOPOLOGY_NAME <span class="token operator">=</span> <span class="token string">"flow:1"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOG <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">HostTrackerImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DataBroker</span> dataService<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> topologyId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> hostPurgeInterval<span class="token punctuation">;</span><span class="token comment">//Purge净化</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> hostPurgeAge<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> exec <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span>CPUS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//java提供的线程服务</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentClusterAwareHostHashMap</span> hosts<span class="token punctuation">;</span><span class="token comment">//自定义的主机host信息集合</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentClusterAwareLinkHashMap</span> links<span class="token punctuation">;</span><span class="token comment">//自定义的连接Link信息集合</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">OperationProcessor</span> opProcessor<span class="token punctuation">;</span><span class="token comment">//自定义的模块操作</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Thread</span> processorThread<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ListenerRegistration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataTreeChangeListener</span><span class="token punctuation">></span></span> addrsNodeListenerRegistration<span class="token punctuation">;</span><span class="token comment">//连续三句多态写法</span>
    <span class="token keyword">private</span> <span class="token class-name">ListenerRegistration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataTreeChangeListener</span><span class="token punctuation">></span></span> hostNodeListenerRegistration<span class="token punctuation">;</span><span class="token comment">//注册监听器</span>
    <span class="token keyword">private</span> <span class="token class-name">ListenerRegistration</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataTreeChangeListener</span><span class="token punctuation">></span></span> linkNodeListenerRegistration<span class="token punctuation">;</span>
  <span class="token comment">/**构造器*/</span>
  <span class="token comment">/**成员方法*/</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      	<span class="token comment">/**起三DataTreeChangeListener监听器*/</span>
   <span class="token punctuation">&#125;</span>
   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataTreeChanged</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataTreeModification</span><span class="token punctuation">&lt;</span><span class="token class-name">DataObject</span><span class="token punctuation">></span><span class="token punctuation">></span></span> changes<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     	   <span class="token comment">/**数据树的改变被转在collection集合中,遍历每一个改变并判断改变的类别,
     	   如果是SUBTREE_MODIFIED:不处理
     	   如果是WRITE:调用onModifiedData(identifier, rootNode);这个方法进一步调用了packetReceived方法
     	   如果是DELETE::调用onDeletedData(identifier, rootNode);这个方法进一步调用了packetReceived方法
     	   其它:结束*/</span>
   <span class="token punctuation">&#125;</span>
  <span class="token comment">/**下述两个方法使用的AddHostBuilder和SayLinkBuilder是两个自定义的notification,各自包含数据*/</span>
  <span class="token comment">/**私有模块对这个方法有改动,增加的部分用region包括*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onModifiedData</span><span class="token punctuation">(</span><span class="token class-name">InstanceIdentifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> iid<span class="token punctuation">,</span> <span class="token class-name">DataObjectModification</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> rootNode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    	<span class="token keyword">final</span> <span class="token class-name">DataObject</span> dataObject <span class="token operator">=</span> rootNode<span class="token punctuation">.</span><span class="token function">getDataAfter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataObject <span class="token keyword">instanceof</span> <span class="token class-name">Addresses</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">packetReceived</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Addresses</span><span class="token punctuation">)</span> dataObject<span class="token punctuation">,</span> iid<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//region:增加通知私有的拓扑模块添加主机</span>
          <span class="token class-name">String</span> nc_id <span class="token operator">=</span>iid<span class="token punctuation">.</span><span class="token function">firstIdentifierOf</span><span class="token punctuation">(</span><span class="token class-name">NodeConnector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">firstKeyOf</span><span class="token punctuation">(</span><span class="token class-name">NodeConnector</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token class-name">Address</span> a <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Address</span><span class="token punctuation">)</span>dataObject<span class="token punctuation">;</span>
          <span class="token class-name">AddHostBuilder</span> ab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AddHostBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          ab<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIpv4Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          ab<span class="token punctuation">.</span><span class="token function">setMac</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getMac</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          ab<span class="token punctuation">.</span><span class="token function">setNcID</span><span class="token punctuation">(</span>nc_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
          notificationService<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>ab<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">//endregion</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dataObject <span class="token keyword">instanceof</span> <span class="token class-name">Node</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            hosts<span class="token punctuation">.</span><span class="token function">putLocally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InstanceIdentifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> iid<span class="token punctuation">,</span> <span class="token class-name">Host</span><span class="token punctuation">.</span><span class="token function">createHost</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">)</span> dataObject<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dataObject <span class="token keyword">instanceof</span>  <span class="token class-name">Link</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            links<span class="token punctuation">.</span><span class="token function">putLocally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InstanceIdentifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> iid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Link</span><span class="token punctuation">)</span> dataObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//region:增加通知私有的拓扑模块添加主机和交换机的连接</span>
         	 <span class="token class-name">Link</span> link<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">Link</span><span class="token punctuation">)</span>dataObject<span class="token punctuation">;</span>
            <span class="token class-name">SayLinkBuilder</span> slb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SayLinkBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            slb<span class="token punctuation">.</span><span class="token function">setLinkType</span><span class="token punctuation">(</span><span class="token string">"onmodified"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            slb<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">getLinkId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            notificationService<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>slb<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//endregion</span>
        <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
    <span class="token comment">/**私有模块对这个方法有改动,增加的部分用region包括*/</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onDeletedData</span><span class="token punctuation">(</span><span class="token class-name">InstanceIdentifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> iid<span class="token punctuation">,</span> <span class="token class-name">DataObjectModification</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> rootNode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span>iid<span class="token punctuation">.</span><span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Node</span> node <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">)</span> rootNode<span class="token punctuation">.</span><span class="token function">getDataBefore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">InstanceIdentifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span> iiN <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstanceIdentifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> iid<span class="token punctuation">;</span>
            <span class="token class-name">HostNode</span> hostNode <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">augmentation</span><span class="token punctuation">(</span><span class="token class-name">HostNode</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hostNode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                hosts<span class="token punctuation">.</span><span class="token function">removeLocally</span><span class="token punctuation">(</span>iiN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iid<span class="token punctuation">.</span><span class="token function">getTargetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Link</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// TODO performance improvement here</span>
            <span class="token class-name">InstanceIdentifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span> iiL <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InstanceIdentifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> iid<span class="token punctuation">;</span>
            links<span class="token punctuation">.</span><span class="token function">removeLocally</span><span class="token punctuation">(</span>iiL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">linkRemoved</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">InstanceIdentifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> iid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Link</span><span class="token punctuation">)</span> rootNode<span class="token punctuation">.</span><span class="token function">getDataBefore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//region:增加通知私有的拓扑模块删除主机和交换机的连接link</span>
         	 <span class="token class-name">Link</span> link<span class="token operator">=</span><span class="token punctuation">(</span><span class="token class-name">Link</span><span class="token punctuation">)</span>rootNode<span class="token punctuation">.</span><span class="token function">getDataBefore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SayLinkBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SayLinkBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">setLinkType</span><span class="token punctuation">(</span><span class="token string">"onDeleted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">setMessage</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">getLinkId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        	sb<span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSourceTp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        	sb<span class="token punctuation">.</span><span class="token function">setDestination</span><span class="token punctuation">(</span>link<span class="token punctuation">.</span><span class="token function">getDestination</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDestTp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            notificationService<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>sb<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//endregion        </span>
        <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">packetReceived</span><span class="token punctuation">(</span><span class="token class-name">Addresses</span> addrs<span class="token punctuation">,</span> <span class="token class-name">InstanceIdentifier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> ii<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**最后调用了processHost(opNode.get(), opNodeConnector.get(), addrs);方法*/</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processHost</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>opendaylight<span class="token punctuation">.</span>yang<span class="token punctuation">.</span>gen<span class="token punctuation">.</span>v1<span class="token punctuation">.</span>urn<span class="token punctuation">.</span>opendaylight<span class="token punctuation">.</span>inventory<span class="token punctuation">.</span>rev130819<span class="token punctuation">.</span>nodes<span class="token punctuation">.</span></span>Node</span> node<span class="token punctuation">,</span>
                             <span class="token class-name">NodeConnector</span> nodeConnector<span class="token punctuation">,</span><span class="token class-name">Addresses</span> addrs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**在这里写到datastore中*/</span>
    <span class="token function">writeDataToDataStore</span><span class="token punctuation">(</span>linksToAdd<span class="token punctuation">,</span> linksToRem<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/**后续的处理方法是增删改查*/</span>
  <span class="token comment">/**关闭模块*/</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        processorThread<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>addrsNodeListenerRegistration<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hostNodeListenerRegistration<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>linkNodeListenerRegistration<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>exec<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hosts<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="inventory"><a href="#inventory" class="headerlink" title="inventory"></a>inventory</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**inventory:
------Host:创建主机对象,写明主机对象有的属性和方法
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="util"><a href="#util" class="headerlink" title="util"></a>util</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**util:
------Compare:提供2个比较方法
-------Utilities:公共工具
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Packet-Handler-主要功能"><a href="#Packet-Handler-主要功能" class="headerlink" title="Packet Handler(主要功能)"></a>Packet Handler(主要功能)</h2><p>​		Packet Handler负责处理控制器涉及的大部分报文,私有功能的逻辑主要在这里定义.相比标准结构,增加了control、icfp两个文件夹,共有decoder(解码器)文件夹和PacketHandlerProvider类,重点关注control和icfp文件夹,以及私有项目对blueprint的改动,对pom.xml文件的改动.</p>
<h3 id="decoder-未改动"><a href="#decoder-未改动" class="headerlink" title="decoder(未改动):"></a>decoder(未改动):</h3><p>​		对decoder的解析详见ARP流程梳理:</p>
<table>
<thead>
<tr>
<th align="center">package\class</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">utils</td>
<td align="center">解码器的工具包</td>
</tr>
<tr>
<td align="center">AbstractPacketDecoder</td>
<td align="center">解码抽象类，所有解码器必须继承实现其中方法</td>
</tr>
<tr>
<td align="center">ArpDecoder</td>
<td align="center">解码ARP报文</td>
</tr>
<tr>
<td align="center">EthernetDecoder</td>
<td align="center">解码以太网帧</td>
</tr>
<tr>
<td align="center">IcmpDecoder</td>
<td align="center">解码Icmp报文</td>
</tr>
<tr>
<td align="center">Ipv4Decoder</td>
<td align="center">解码Ipv4报文</td>
</tr>
<tr>
<td align="center">Ipv6Decoder</td>
<td align="center">解码Ipv6报文,在私有系统中暂时不涉及</td>
</tr>
</tbody></table>
<h3 id="PacketHandlerProvider（未改动）："><a href="#PacketHandlerProvider（未改动）：" class="headerlink" title="PacketHandlerProvider（未改动）："></a>PacketHandlerProvider（未改动）：</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**PacketHandlerProvider:模块的入口*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PacketHandlerProvider</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOG <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">PacketHandlerProvider</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//不可变集合ImmutableSet</span>
    <span class="token class-name">ImmutableSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractPacketDecoder</span><span class="token punctuation">></span></span> decoders<span class="token punctuation">;</span>
  	<span class="token comment">//引入Notification服务,在blueprint中引入,是否实现Notification功能,后续实现</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">NotificationProviderService</span> notificationService<span class="token punctuation">;</span>
	<span class="token comment">//构造器,有参</span>
    <span class="token keyword">public</span> <span class="token class-name">PacketHandlerProvider</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">NotificationProviderService</span> notificationService<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notificationService <span class="token operator">=</span> notificationService<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  	<span class="token comment">//初始化模块,new一堆解码器</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initiateDecoders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        decoders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ImmutableSet<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractPacketDecoder</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EthernetDecoder</span><span class="token punctuation">(</span>notificationService<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArpDecoder</span><span class="token punctuation">(</span>notificationService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Ipv4Decoder</span><span class="token punctuation">(</span>notificationService<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Ipv6Decoder</span><span class="token punctuation">(</span>notificationService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IcmpDecoder</span><span class="token punctuation">(</span>notificationService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"PacketHandler initialized."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token comment">//侦测有解码器对象在,遍历关闭	</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeDecoders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>decoders <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>decoders<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractPacketDecoder</span> decoder <span class="token operator">:</span> decoders<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                decoder<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"PacketHandler (instance &#123;&#125;) torn down."</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="blueprint-packet-handler-xml"><a href="#blueprint-packet-handler-xml" class="headerlink" title="blueprint:packet-handler.xml"></a>blueprint:packet-handler.xml</h3><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!--标准l2switch中的blueprint很简洁,类只注册了入口PacketHandlerProvider,服务只引入了notificationService--></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notificationService<span class="token punctuation">"</span></span>
   <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.opendaylight.controller.sal.binding.api.NotificationProviderService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>packetHandler<span class="token punctuation">"</span></span>
   <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.opendaylight.l2switch.packethandler.PacketHandlerProvider<span class="token punctuation">"</span></span>
   <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>initiateDecoders<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>closeDecoders<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notificationService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>
     
<span class="token comment">&lt;!--私有项目中对应的blueprint由于增加了功能,注册了新的类,引入了新的服务,略写列在下面--></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>reference</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataBroker<span class="token punctuation">"</span></span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.opendaylight.controller.md.sal.binding.api.DataBroker<span class="token punctuation">"</span></span><span class="token attr-name"><span class="token namespace">odl:</span>type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>default<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">odl:</span>rpc-service</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>salFlowService<span class="token punctuation">"</span></span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.opendaylight.yang.gen.v1.urn.opendaylight.flow.service.rev130819.SalFlowService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">odl:</span>rpc-service</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>packetHandlerService<span class="token punctuation">"</span></span> <span class="token attr-name">interface</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.opendaylight.yang.gen.v1.urn.opendaylight.packet.service.rev130709.PacketProcessingService<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token comment">&lt;!--私有项目注册了其它入口--></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ControlServiceIml<span class="token punctuation">"</span></span>
   <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.opendaylight.l2switch.packethandler.control.service.ControlServiceIml<span class="token punctuation">"</span></span>
   <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>init<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>salFlowService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>packetHandlerService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataBroker<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notificationService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>MyOdlProvider<span class="token punctuation">"</span></span>
   <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.opendaylight.l2switch.packethandler.control.ControlProvider<span class="token punctuation">"</span></span>
   <span class="token attr-name">init-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>init<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>salFlowService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>packetHandlerService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataBroker<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argument</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notificationService<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="pom-xml-增加了依赖项"><a href="#pom-xml-增加了依赖项" class="headerlink" title="pom.xml:增加了依赖项"></a>pom.xml:增加了依赖项</h3><p>​		增加了依赖项,主要是openflowplugin、snmp、json等方面.</p>
<h3 id="control-增加"><a href="#control-增加" class="headerlink" title="control(增加):"></a>control(增加):</h3><table>
<thead>
<tr>
<th align="center">package\class</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">config</td>
<td align="center">存放系统的配置,提供三种配置Link、Node、Rule，以集合的形式存在总配置对象ConfObject中</td>
</tr>
<tr>
<td align="center">entity(实例)</td>
<td align="center">类似于工具类,放了一些功能的实例类,但是大部分代码由于各种原因已经不适用了,保留是因为还没来得及删除或留待以后拓展</td>
</tr>
<tr>
<td align="center">flow</td>
<td align="center">包括下发流表的单例,创建\下发控制器到控制器的初始流表</td>
</tr>
<tr>
<td align="center">inventory</td>
<td align="center">保存信息,创建保存信息的数据结构,以及读取ODL内存的功能类</td>
</tr>
<tr>
<td align="center">listener</td>
<td align="center">创建了各种消息的侦听器</td>
</tr>
<tr>
<td align="center">pathfinding</td>
<td align="center">计算内部\外部路径</td>
</tr>
<tr>
<td align="center">processer</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">service</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">util</td>
<td align="center">工具类</td>
</tr>
<tr>
<td align="center">ControlProvider</td>
<td align="center">control的入口类,在blueprint中有注册</td>
</tr>
<tr>
<td align="center">CustomPacketDispatch</td>
<td align="center">自定义的分发包方法</td>
</tr>
</tbody></table>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**Config:*/</span>
<span class="token comment">/**在三种配置的上层,建立了三个集合存放不同的配置对象*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConfObject</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> outer_dpid<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//初始化值,-1无效</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LinkConfInfo</span><span class="token punctuation">></span></span> link<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//存放连接配置</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> controller<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">NodeConfInfo</span><span class="token punctuation">></span></span> nodeConfInfo<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//存放节点配置</span>
   <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RuleConfInfo</span><span class="token punctuation">></span></span> rules<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//存放规则配置</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/**下面三类配置类都比较简单,就是成员变量+构造器*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkConfInfo</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> channel<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> interval<span class="token punctuation">;</span><span class="token comment">//端口之间同步的间隔</span>
  <span class="token comment">/**构造器*/</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NodeConfInfo</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> node_level<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> node_num<span class="token punctuation">;</span>
  <span class="token comment">/**构造器*/</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/**所谓规则Rule就是从这个口到那个口\这个地址到那个地址走哪个信道?优先级多少?之类的可配置的选项*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuleConfInfo</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> source_ip<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> source_mac<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> des_port_num<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> protocol_type<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> priority<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> channel<span class="token punctuation">;</span>
  <span class="token comment">/**构造器*/</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**entity:
------flow:早期用于下流表的代码,由于改需求已经不用了,暂时没删除,供参考
------highlight:控制拓扑有流量时高亮功能的代码,,现在是由自己的前端控制,已经不用了,供参考
------host:存放外网交换机的dpid和mac,包括源和目的,暂时用不上
------internal:处理车内终端和链接状态
------multicast:(多播)
------path:包括路径对象,和路径的配置等等
------rule:现在用其他方法配规则,已经不用了
------Narrowband.java(窄带):读窄带端机的信息,ip\掩码\下一跳等*/</span>
<span class="token comment">/**flow:包含4*xx.java*/</span>
	<span class="token comment">//自定义动作项</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomActionItem</span><span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span> <span class="token keyword">int</span> out_put<span class="token punctuation">;</span>
  <span class="token comment">/**构造器*/</span>
<span class="token punctuation">&#125;</span>
	<span class="token comment">//自定义匹配项</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomMatchItem</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> s_ip<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> d_ip<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> s_mac<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> d_mac<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> protocol_num <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> l4_source_num<span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> l4_destination_num <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">/**标准配置*/</span>
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**构造器*/</span>
<span class="token punctuation">&#125;</span>
	<span class="token comment">//说明了一条流表的基本状态</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowObject</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token class-name">FlowStatus</span> flowStatus<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> chao_duan_bo<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Path</span><span class="token punctuation">></span></span> in_car_paths<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//车内路径</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Path</span><span class="token punctuation">></span></span> external_paths<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//车间路径</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> onSameCar<span class="token operator">=</span><span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> onSameCar_dpid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  	<span class="token comment">//每个交换机对应一个Action列表</span>
  <span class="token keyword">public</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">CustomActionItem</span><span class="token punctuation">></span><span class="token punctuation">></span></span>action_map<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> rule_list<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
	<span class="token comment">//</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">FlowStatus</span><span class="token punctuation">&#123;</span>
  NO_ARP<span class="token punctuation">,</span><span class="token comment">//无arp响应</span>
  NO_BETWEEN_PATH<span class="token punctuation">,</span><span class="token comment">//无车间路径</span>
  IN_CAR_FLOW<span class="token punctuation">,</span><span class="token comment">//车内的流表</span>
  BETWEEN_FLOW<span class="token comment">//车间的流表</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**flow:
----FlowWriter.java:下发流表的功能类,调用salFlowService服务，包括创建、下发、删除流表、创建动作和指令等
----InitialC2CFlowWriter.java:创建系统启动时下发的流表,C2C:一个控制器到另一个控制器*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowWriter</span><span class="token punctuation">&#123;</span>
  <span class="token comment">//成员对象</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">FlowWriter</span> instance<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FlowWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//饿汉单例,别人不能new它,只能调用它</span>
  <span class="token keyword">private</span> <span class="token class-name">SalFlowService</span>  salFlowService <span class="token punctuation">;</span>
  <span class="token comment">//构造器</span>
  <span class="token keyword">private</span> <span class="token class-name">FlowWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token comment">//饿汉单例</span>
  <span class="token comment">//getter  setter方法</span>
  <span class="token comment">//成员方法</span>
  <span class="token function">addFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/**包括:_inCar,_CHAODUANBO,_multicast,SegmentedPath(分段路径), */</span>
  <span class="token function">createFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/**包括:CHAODUANBO,_multicast,remove*/</span>
  <span class="token function">removeFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/***/</span>
  <span class="token function">createInstructions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/***/</span>
  <span class="token function">createAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/**SetFieldDestinationMacAddress,OutPut,*/</span>
  <span class="token function">getmaskIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//处理掩码和IP</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InitialC2CFlowWriter</span> <span class="token keyword">implements</span> <span class="token class-name">DataTreeChangeListener</span><span class="token generics"><span class="token punctuation">&lt;</span>node<span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>
  <span class="token comment">//成员对象</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> FLOW_ID_PREFIX<span class="token operator">=</span> <span class="token string">"l2switch-"</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> C2C_ETHER_TYPE<span class="token operator">=</span><span class="token number">2320</span><span class="token punctuation">;</span><span class="token comment">//私有的以太网类型,0x0910</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ExecutorService</span> initialFlowExecutor<span class="token operator">=</span><span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SalFlowService</span>  salFlowService <span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">short</span> flowTableId<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">int</span> flowPriority <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">int</span> flowIdleTimeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">int</span> flowHardTimeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> flowIdInc<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicLong</span> flowCookieInc<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span>x2b0000000000000L<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//构造器</span>
   <span class="token keyword">public</span> <span class="token class-name">InitialC2CFlowWriter</span><span class="token punctuation">(</span><span class="token class-name">SalFlowService</span>  salFlowService <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//成员方法</span>
   <span class="token function">onDataTreeChanged</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataTreeModification</span><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">></span><span class="token punctuation">></span></span> changes<span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">//内部成员类 </span>
   <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InitialFlowWriterProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span>
     <span class="token function">addInitialFlows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">getTableInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">getFlowInstanceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">createControllerToControllerFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">createDefaultFlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">getSendToControllerAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">writeFlowToController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**inventory:   
------FlowDB: 保存路径,包括源和目的在同一台车或不在同一台车,由于改需求,已经不用了,不需要保存路径了
------InternalDB:给一台车本身的大部分配置都建好集合,从配置文件或其它渠道拿到数据后再存到里面
------InventoryReader:参考arphandler.inventory.InventoryReader写的读取ODL内存的功能类,还命名为InventoryReader,变化不大
------RuleDB:保存规则,配置信息等,现在已经不用这种方式配置规则了,只保留了ALL_CHANNEL_LIST,写死5种信道
*/</span>
<span class="token comment">/**FlowDB: */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowDB</span><span class="token punctuation">&#123;</span>
  	<span class="token comment">//源和目的在同一台车,保存转发端口就可以</span>
  <span class="token function">updateInCarFlowMap_SameCar</span><span class="token punctuation">(</span><span class="token keyword">int</span> dpid<span class="token punctuation">,</span><span class="token class-name">String</span> s_ip<span class="token punctuation">,</span><span class="token class-name">String</span> d_ip<span class="token punctuation">,</span><span class="token keyword">int</span> output_port<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  	<span class="token comment">//源和目的不在一个车内,需要保存路径计算的结果,就是一个List集合</span>
  <span class="token function">updateInCarFlowMap_Path</span><span class="token punctuation">(</span><span class="token class-name">String</span> s_ip<span class="token punctuation">,</span><span class="token class-name">String</span> d_ip<span class="token punctuation">,</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Path</span><span class="token punctuation">></span></span> paths<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/**InternalDB:  */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternalDB</span><span class="token punctuation">&#123;</span>
  <span class="token comment">/**成员对象*/</span>
  		<span class="token comment">//new一个空的配置对象</span>
 	   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ConfObject</span> confObject <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  		<span class="token comment">//外部交换机的dpid</span>
  	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> EXT_SWITCH_DPID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">Boolean</span><span class="token punctuation">></span></span> EXT_NODE_PORT_STATUS<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  		<span class="token comment">//网关</span>
  		<span class="token comment">//车间连接端口:从配置文件中读取车是通过哪些端口连起来的</span>
  		<span class="token comment">//端机MAC:</span>
  		<span class="token comment">//窄带端机都挂载在哪个交换机下面</span>
  		<span class="token comment">//有哪些车内交换机:内网\外网交换机都读</span>
  		<span class="token comment">//车内主机mac:</span>
  		<span class="token comment">//本车交换机mac:</span>
  		<span class="token comment">//本车的角色配置:</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/**InventoryReader:  */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InventoryReader</span> <span class="token keyword">implements</span> <span class="token class-name">DataTreeChangeListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataObject</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>
  <span class="token comment">/**成员对象*/</span>
  	 <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOG<span class="token operator">=</span><span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">InventoryReader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	 <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Databroker</span> databroker<span class="token punctuation">;</span>
	   <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">NodeConnectorRef</span><span class="token punctuation">></span><span class="token punctuation">></span></span> controllerSwitchConnectors<span class="token punctuation">;</span>
       <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">NodeConnectorRef</span><span class="token punctuation">></span><span class="token punctuation">></span></span> switchNodeConnectors<span class="token punctuation">;</span>
  	 <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Registration</span><span class="token punctuation">></span></span> listenerRegistrationList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	 <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> refreshData <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token comment">//使用volatile关键字会强制将修改的值立即写入主存,任意线程修改了这个值,对其它线程立即可见</span>
  	 <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> refreshDataDelay <span class="token operator">=</span> <span class="token number">20L</span><span class="token punctuation">;</span>
  	 <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> refreshDataScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  	 <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> nodeConnectorDataChangeEventProcessor<span class="token operator">=</span><span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**构造器*/</span>
  <span class="token comment">/**getter、setter方法*/</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRefreshData</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> refreshData<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/**成员方法*/</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerAsDataChangeListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onDataTreeChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//读取data tree以查找有关节点node和节点连接器NodeConnectors的信息。为给定交换机创建NodeConnector的List集合。还确定每个NodeConnector的STP状态。</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readInventory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/**RuleDB:  */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RuleDB</span><span class="token punctuation">&#123;</span>
  <span class="token comment">/**成员对象*/</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> ALL_CHANNEL_LIST <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**listener:这个package大部分都在用的,不只是监听器,还包括了监听到事件后进一步采取的基本措施,
				比如:发报文\下流表\存信息等
------ARPlistener:监听ARP报文,并对收到的ARP报文进行解析并发送
------C2CPacketListener:监听C2C报文,并对收到的报文分情况判断,解析,再发送出去,其中的反向流表已经没有这个概念了,
		 由于代码调整,目前只有组播流表下发还在使用
------HostInfoListener:监听主机上线,发现上线后获取主机的信息,存储主机的信息,再完成洪泛主机的存在,
		 下发必要流表等功能,包括免费ARP报文;主机下线后删除相关的信息,以及处理其他,SayLink代表Link发生变动
------LldpListener:收到LLDP报文,分析\过滤掉不要的报文,处理LLDP报文发现的连接关系,生成流表之类的
------SegmentedPathCalculationListener:计算分段路径
------TopoChangeNotificationListener:监听拓扑变化,处理拓扑变化带来的后续动作,增删节点\设备,洪泛信息,重算路径等等
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**pathfinding:
------ExtPathFinder:
------InnerPathFinder:
*/</span>
<span class="token comment">/**ExtPathFinder: 计算外部路径*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExtPathFinder</span><span class="token punctuation">&#123;</span>
  <span class="token comment">/**只包括一个成员方法:计算符合ruleList规则的node_map节点中,从start_node_id到end_node_id的路径,
       返回的结果是Path_Result类型的,包括开始节点、结束节点、距离、路径，共四个属性*/</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Path_Result</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token keyword">int</span> start_node_id<span class="token punctuation">,</span><span class="token keyword">int</span> end_node_id<span class="token punctuation">,</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> ruleList<span class="token punctuation">,</span>
                                      					<span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">T_Node</span><span class="token punctuation">></span></span> node_map<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token comment">/**这里的原理就是迪杰特斯拉算法,ruleList相当于是计算时的限制条件,后续要详细梳理以下它的实现过程*/</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**InnerPathFinder: 计算内部路径*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InnerPathFinder</span><span class="token punctuation">&#123;</span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Path_Result</span> <span class="token function">calculate</span><span class="token punctuation">(</span><span class="token keyword">int</span> start_node_id<span class="token punctuation">,</span><span class="token keyword">int</span> end_node_id<span class="token punctuation">,</span><span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span><span class="token class-name">T_Node_InCar</span><span class="token punctuation">></span></span> node_map<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
   <span class="token comment">/**思路跟外部路径类似,但是涉及的计算对象和条件不同,也是返回一个Path_Result类型结果*/</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**processor：
------Ipv4Handler:
------Ipv4Processor:
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**service:
------entity(package):
------ControlServiceImpl:
------HighlightKey:
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**util:
------byteencode:
------flowcapablenodemapping:
------instanceidentifierutils:
------multicastutil:组播
------unicastutil:单播
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**ControlProvider:  */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ControlProvider</span><span class="token punctuation">&#123;</span>
  <span class="token comment">/**成员对象*/</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DataBroker</span> dataService；
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SalFlowService</span> salFlowService；
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">NotificationProviderService</span> notificationService；
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">PacketProcessingService</span> packetProcessingService；
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> PATH_MODE <span class="token operator">=</span> <span class="token number">1</span>；<span class="token comment">//0:源节点计算整条路径  1:各节点分别计算</span>
    	<span class="token comment">//多态写法</span>
  	<span class="token keyword">private</span> <span class="token class-name">Registration</span> initialFlowWriterListenerReg<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">Registration</span> arpHandlerRegistration<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">Registration</span> unicastArpHandlerRegistration<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">Registration</span> ipv4HandlerRegistration<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">Registration</span> c2cListenerRegistration<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">Registration</span> lldpListenerRegistration<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">Registration</span> segmentedPathProcessorRegistration<span class="token punctuation">;</span>
      <span class="token keyword">private</span> <span class="token class-name">Registration</span> icfpListenerReg<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Icfpv2Target</span> icfpv2Target<span class="token punctuation">;</span>
  <span class="token comment">/**构造器*/</span>
  <span class="token comment">/**成员方法*/</span>
  	<span class="token comment">//从文件中读取系统配置,conf.json</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readconf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">//初始化:把该模块涉及到的对象\多态全new出来,并传给成员对象,包括调用注册类Registration多态实现类等</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  	<span class="token comment">//关闭</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**CustomPacketDispatcher: 自定义的分发包方法,不同需求的发包方法都定义在这 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomPacketDispatcher</span><span class="token punctuation">&#123;</span>
  <span class="token comment">/**成员对象*/</span>
  <span class="token keyword">private</span> <span class="token class-name">InventoryReader</span> inventoryReader<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">PacketProcessingService</span> packetProcessingService<span class="token punctuation">;</span>
  <span class="token comment">/**getter,setter方法*/</span>
  <span class="token comment">/**没写构造器,默认是无参构造器*/</span>
  <span class="token comment">/**成员方法*/</span>
  	<span class="token comment">//发送包，调用了底层的TransmitPacketInput，以及Future</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendPacketOut</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> payload<span class="token punctuation">,</span><span class="token class-name">NodeConnectorRef</span> ingress<span class="token punctuation">,</span><span class="token class-name">NodeConnectorRef</span> egress<span class="token punctuation">)</span>；
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendData2Port</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">,</span><span class="token class-name">String</span> node_id<span class="token punctuation">,</span><span class="token keyword">int</span> outport_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">floodArpRequest</span><span class="token punctuation">(</span><span class="token class-name">String</span> s_ip<span class="token punctuation">,</span><span class="token class-name">String</span> d_ip<span class="token punctuation">,</span><span class="token class-name">String</span> s_mac<span class="token punctuation">,</span><span class="token class-name">NodeConnectorRef</span> nodeConnectorRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendArpRequest</span><span class="token punctuation">(</span><span class="token class-name">String</span> s_ip<span class="token punctuation">,</span><span class="token class-name">String</span> d_ip<span class="token punctuation">,</span><span class="token class-name">String</span> s_mac<span class="token punctuation">,</span><span class="token class-name">String</span> nodeId<span class="token punctuation">,</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InternalLink</span><span class="token punctuation">></span></span> links<span class="token punctuation">,</span><span class="token class-name">NodeConnectorRef</span> origIngress<span class="token punctuation">,</span><span class="token keyword">boolean</span> external<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="icfp-增加"><a href="#icfp-增加" class="headerlink" title="icfp(增加):"></a>icfp(增加):</h3><table>
<thead>
<tr>
<th align="center">package\class</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">icsp</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">igmp</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">master</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">timer</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">utils</td>
<td align="center"></td>
</tr>
</tbody></table>
<h2 id="loopremover-暂不使用"><a href="#loopremover-暂不使用" class="headerlink" title="loopremover(暂不使用)"></a>loopremover(暂不使用)</h2><p>​		loopremover模块使用stp协议消除环路,生成无环拓扑图,在目前的私有项目中不考虑这一部分,因为机动通信系统的组织架构天然是胖树结构没有环,甚至天然是路径树,所以不需要去除环路的部分,不过为丰富代码的健壮性,这个功能将来需要补充.loopremover的结构跟l2switch-main类似:</p>
<h3 id="loopremoverprovider"><a href="#loopremoverprovider" class="headerlink" title="loopremoverprovider"></a>loopremoverprovider</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**loopremoverprovider:模块的入口*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoopRemoverProvider</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">/**成员对象*/</span>
  <span class="token comment">/**构造器*/</span>
  <span class="token comment">/**init:如果isIsInstallLldpFlow配置为true,则调用InitialFlowWriter下发初始流表
  		  调用TopologyLinkDataChangeHandler监听拓扑数据变化,等待graphrefreshdelay(环路计算间隔时间)
  		  后调用NetworkGraphImpl对拓扑去环路*/</span>
  <span class="token comment">/**close*/</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="flow-1"><a href="#flow-1" class="headerlink" title="flow"></a>flow</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**flow:
------InitialFlowWriter:在所有交换机上添加一个将所有LLDP数据包发送到控制器的流。注册为ODL
									资源清册侦听器，以便在添加新节点（即交换机）后添加流。
									InitialFlowWriterProcessor中包含添加流表、创建流表、写入流表等方法
*/</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="topology"><a href="#topology" class="headerlink" title="topology"></a>topology</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**topology:处理拓扑,这里只简单的分析一下networkgraphimpl
------networkgraphimpl:去除环路的类,内部使用Jung图库维护图，并使用Dijkstra算法以最佳方式返回最短路径。
------networkgraphservice:上述类的接口
------topologylinkdatachangehandler:订阅了拓扑变化的notification,并处理拓扑变化
*/</span>
<span class="token comment">/**默认注释掉了迪杰特斯拉算法,都是用的jung库中的方法计算的*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NetworkGraphImpl</span> <span class="token keyword">implements</span> <span class="token class-name">NetworkGraphService</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">/**成员对象*/</span>
   <span class="token comment">/**成员方法*/</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">addLinks</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span> links<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">linkAlreadyAdded</span><span class="token punctuation">(</span><span class="token class-name">Link</span> link<span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">removeLinks</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span> links<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    	<span class="token comment">/**这个方法中调用了jung库中的虽小生成树算法:PrimMinimumSpanningTree,在这里去的环*/</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span> <span class="token function">getLinksInMst</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span> linksInMst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>networkGraph <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">PrimMinimumSpanningTree</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NodeId</span><span class="token punctuation">,</span> <span class="token class-name">Link</span><span class="token punctuation">></span></span> networkMst <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrimMinimumSpanningTree</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>
                    <span class="token class-name">DelegateTree</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NodeId</span><span class="token punctuation">,</span> <span class="token class-name">Link</span><span class="token punctuation">></span></span><span class="token function">getFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Graph</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NodeId</span><span class="token punctuation">,</span> <span class="token class-name">Link</span><span class="token punctuation">></span></span> mstGraph <span class="token operator">=</span> networkMst<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>networkGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span> mstLinks <span class="token operator">=</span> mstGraph<span class="token punctuation">.</span><span class="token function">getEdges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            linksInMst<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>mstLinks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> linksInMst<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Link</span><span class="token punctuation">></span></span> <span class="token function">getAllLinks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>参考文献：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_31821675/article/details/65628266">最小生成树MST（Minimum Spanning Tree)-普里姆(Prim)算法</a></li>
</ul>
<h3 id="util-1"><a href="#util-1" class="headerlink" title="util"></a>util</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**util:工具类
------InstanceIdentifierUtils:
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="l2switch-main-不使用"><a href="#l2switch-main-不使用" class="headerlink" title="l2switch-main(不使用)"></a>l2switch-main(不使用)</h2><p>​		这个模块在标准项目中是主要服务的提供者，由<code>L2SwitchMainProvider</code>控制工作流程.私有项目自己定义了更复杂的工作流程，所以在blueprint.xml中彻底把这个模块关闭.</p>
<p>​		l2switch-main表现出来的运行逻辑是比较清晰的,入口根据配置文件的不同模式给交换机下发不同的流表,并且在下发流表的过程中订阅了notification,能够与之前梳理的decoder对应上,给出了inventoryreader,提供了操作ODL内存的方法,用到了yang模型生成的工具.对一个交换机而言,正确的转发报文已经是非常基础的内容了,通过梳理l2switch-main对ODL简单控制逻辑已经比较了解了.这里用这个模块顺便总结一下如何快速阅读一个ODL模块:</p>
<h3 id="l2switch-impl-xml"><a href="#l2switch-impl-xml" class="headerlink" title="l2switch-impl.xml"></a>l2switch-impl.xml</h3><p>​		<strong>首先</strong>阅读blueprint.xml能够迅速理清这个模块：</p>
<ul>
<li>引用哪些服务，比如<code>dataBroker</code>和<code>notification</code>等</li>
<li>发布哪些服务，比如rpc和notification等</li>
<li>模块的入口，在<bean></bean>中写明入口类及其初始化方法和关闭方法,一般是<code>init\start</code>和<code>close</code></li>
</ul>
<h3 id="yang"><a href="#yang" class="headerlink" title="yang"></a>yang</h3><p>​		<strong>然后</strong>阅读yang文件,yang文件定义了这个模块功能模型,能迅速明白这个模块用到的功能,yang文件经过yangtools生成的工具类在如下路径,模块内的方法会调用到这些工具类,有的模块有多个位置放yang文件.</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">target<span class="token operator">/</span>generated<span class="token operator">-</span>sources<span class="token operator">/</span>mdsal<span class="token operator">-</span>binding<span class="token operator">/</span>org<span class="token operator">/</span>opendaylight<span class="token operator">/</span>yang<span class="token operator">/</span>gen<span class="token operator">/</span>v1<span class="token operator">/</span>urn<span class="token operator">/</span>opendaylight<span class="token operator">/</span>l2switch<span class="token operator">/</span>l2switch<span class="token operator">/</span>config<span class="token operator">/</span>rev140528<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-yang" data-language="yang"><code class="language-yang">#l2switch-config.yang定义了l2Switch的一系列默认配置,并在入口类被读取到方法中<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="L2SwitchMainProvider"><a href="#L2SwitchMainProvider" class="headerlink" title="L2SwitchMainProvider"></a>L2SwitchMainProvider</h3><p>​		<strong>最后</strong>从模块入口阅读具体代码:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**L2SwitchMainProvider的结构比较简单,大概就是读取yang定义的配置*/</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">L2SwitchMainProvider</span> <span class="token punctuation">&#123;</span>
 <span class="token comment">/**成员对象*/</span>
 <span class="token comment">/**有参构造器*/</span>
 <span class="token comment">/**init方法:把yang文件中的配置读取到FlowWriterServiceImpl的对象中 ,初始化InventoryReader
  				如果配置文件中是isIsInstallDropallFlow,就调用initialflowwriter下发dropall流表
  				如果isIsLearningOnlyMode为false,就调用ReactiveFlowWriter下发流表/
 /**close方法*/</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="flow-2"><a href="#flow-2" class="headerlink" title="flow"></a>flow</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**flow:
------flowwriterservice:接口,规定了两个添加flow的方法
------flowwriterserviceimpl:实现上面接口,负责添加、创建、下发流表
------initialflowwriter:创建dropall流表
------reactiveflowwriter:动态的创建流表，订阅了onArpPacketReceived的notification
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="inventory-1"><a href="#inventory-1" class="headerlink" title="inventory"></a>inventory</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**inventory:
------inventoryreader:提供读取ODL内存的方法
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="util-2"><a href="#util-2" class="headerlink" title="util"></a>util</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**util:
------InstanceIdentifierUtils:工具方法
*/</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/L2switch/" rel="tag"># L2switch</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/09/01/Bug%E6%94%B6%E9%9B%86/" rel="prev" title="Bug收集">
                  <i class="fa fa-chevron-left"></i> Bug收集
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/09/01/Openflowplugin/" rel="next" title="Openflowplugin">
                  Openflowplugin <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Simonck</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>
-->

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/third-party/pace.js"></script>

  





</body>
</html>
